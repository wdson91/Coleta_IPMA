<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Previs√£o do Tempo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-5">
    <button onclick="window.location.href='/'">Home</button>
    <h1>Coleta com Requests</h1>
    
    <h1 class="mb-4">Previs√£o do Tempo por Localidade</h1>

    <div class="row mb-3">
      <div class="col-md-6">
        <label for="distritos" class="form-label">Distrito:</label>
        <select id="distritos" class="form-select">
          <option value="">-- Selecione um distrito --</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="locations" class="form-label">Localidade:</label>
        <select id="locations" class="form-select">
          <option value="">-- Selecione uma localidade --</option>
        </select>
      </div>
    </div>

    <button id="btn-previsao" class="btn btn-primary mb-4">Ver Previs√£o</button>

    <div class="row mb-3">
  <div class="col-md-6">
    <label for="filtro-data" class="form-label">Filtrar por data:</label>
    <input type="date" id="filtro-data" class="form-control">
  </div>
</div>
    <h2>Previs√£o do Tempo:</h2>
    <div id="resultado-previsao" class="row"></div>
  </div>

  <script>
    
  let todasAsLocalidades = [];
  let dadosOriginais = []; // Para armazenar os dados recebidos

  const tiposTempo = {
    0:  { desc: "C√©u limpo", icon: "‚òÄÔ∏è" },
    1:  { desc: "C√©u pouco nublado", icon: "üå§Ô∏è" },
    2:  { desc: "C√©u parcialmente nublado", icon: "‚õÖ" },
    3:  { desc: "C√©u muito nublado", icon: "‚òÅÔ∏è" },
    4:  { desc: "C√©u encoberto", icon: "‚òÅÔ∏è" },
    5:  { desc: "Aguaceiros", icon: "üå¶Ô∏è" },
    6:  { desc: "Aguaceiros fortes", icon: "üåßÔ∏è" },
    7:  { desc: "Chuva", icon: "üåßÔ∏è" },
    8:  { desc: "Chuva forte", icon: "üåßÔ∏è" },
    9:  { desc: "Chuva e trovoada", icon: "‚õàÔ∏è" },
    10: { desc: "Aguaceiros e trovoada", icon: "‚õàÔ∏è" },
    11: { desc: "Neve", icon: "‚ùÑÔ∏è" },
    12: { desc: "Nevoeiro ou neblina", icon: "üå´Ô∏è" },
  };

  async function carregarDistritos() {
    const res = await fetch('/get_distritos');
    const distritos = await res.json();

    const select = document.getElementById('distritos');
    distritos.forEach(d => {
      const option = document.createElement('option');
      option.value = d.idDistrito;
      option.textContent = d.nome;
      select.appendChild(option);
    });
  }

  async function carregarLocalidades() {
    const res = await fetch('/get_locations');
    todasAsLocalidades = await res.json();
  }

  function filtrarLocalidadesPorDistrito(idDistrito) {
    const select = document.getElementById('locations');
    select.innerHTML = '<option value="">-- Selecione uma localidade --</option>';

    const filtradas = todasAsLocalidades.filter(loc => loc.idDistrito == idDistrito);
    filtradas.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc.globalIdLocal;
      option.textContent = loc.local;
      select.appendChild(option);
    });
  }

  function renderizarPrevisoes(dados) {
    const resultado = document.getElementById('resultado-previsao');
    resultado.innerHTML = "";

    if (dados.length === 0) {
      resultado.innerHTML = "<p>Nenhuma previs√£o encontrada para a data selecionada.</p>";
      return;
    }

    dados.forEach(dia => {
      const tipo = tiposTempo[dia.idTipoTempo] || { desc: "Desconhecido", icon: "‚ùî" };

      const card = document.createElement('div');
      card.className = "col-md-4 mb-4";

      card.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">${new Date(dia.dataPrev).toLocaleDateString('pt-BR')}</h5>
            <p class="card-text">
              <strong>${tipo.icon} ${tipo.desc}</strong><br>
              <strong>Intervalo:</strong> ${dia.intervaloHora || ''} <br>
              <strong>M√°xima:</strong> ${dia.tMax}¬∞C<br>
              <strong>M√≠nima:</strong> ${dia.tMin}¬∞C<br>
              <strong>Precipita√ß√£o:</strong> ${dia.probabilidadePrecipita || 0}%<br>
              <strong>Vento:</strong> ${dia.ddVento} (for√ßa ${dia.idFfxVento})<br>
              <strong>√çndice UV:</strong> ${dia.iUv || 'N/A'}<br>
            </p>
          </div>
        </div>
      `;

      resultado.appendChild(card);
    });
  }

  function filtrarPorData(dataSelecionada) {
  if (!dadosOriginais.length) return;

  if (!dataSelecionada) {
    // Se o filtro foi limpo, mostrar todos os dados
    renderizarPrevisoes(dadosOriginais);
    return;
  }
  
  const filtrados = dadosOriginais.filter(dia => {
    const dataObj = new Date(dia.dataPrev);
    const dataFormatada = dataObj.getFullYear() + '-' +
      String(dataObj.getMonth() + 1).padStart(2, '0') + '-' +
      String(dataObj.getDate()).padStart(2, '0');
    return dataFormatada === dataSelecionada;
  });

  renderizarPrevisoes(filtrados);
}

  document.getElementById('btn-previsao').addEventListener('click', async () => {
    const select = document.getElementById('locations');
    const globalIdLocal = select.value;
    const resultado = document.getElementById('resultado-previsao');

    if (!globalIdLocal) {
      alert("Por favor, selecione uma localidade.");
      return;
    }

    resultado.innerHTML = "<p>Carregando previs√£o...</p>";

    try {
      const res = await fetch(`https://api.ipma.pt/public-data/forecast/aggregate/${globalIdLocal}.json`);
      const dados = await res.json();

      // Armazena todos os dados v√°lidos com vento
      dadosOriginais = dados.filter(dia => dia.hasOwnProperty('idFfxVento'));

      // Verifica se j√° existe data selecionada
      const dataSelecionada = document.getElementById('filtro-data').value;
      
      if (dataSelecionada) {
        filtrarPorData(dataSelecionada);
      } else {
        renderizarPrevisoes(dadosOriginais);
      }

    } catch (err) {
      console.error("Erro ao buscar previs√£o:", err);
      resultado.innerHTML = "<p class='text-danger'>Erro ao obter previs√£o.</p>";
    }
  });


  document.getElementById('filtro-data').addEventListener('change', (e) => {
    const dataSelecionada = e.target.value;
    filtrarPorData(dataSelecionada);
  });

  document.addEventListener('DOMContentLoaded', async () => {
    await carregarDistritos();
    await carregarLocalidades();

    document.getElementById('distritos').addEventListener('change', (e) => {
      const idDistrito = e.target.value;
      if (idDistrito) {
        filtrarLocalidadesPorDistrito(idDistrito);
      } else {
        document.getElementById('locations').innerHTML = '<option value="">-- Selecione uma localidade --</option>';
      }
    });
  });


  </script>
</body>
</html>
