<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Previsão do Tempo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-5">
     <button onclick="window.location.href='/'">Home</button>
    <h1>Coleta com Playwright</h1>
   
    <h1 class="mb-4">Previsão do Tempo por Localidade</h1>

    <div class="row mb-3">
      <div class="col-md-6">
        <label for="distritos" class="form-label">Distrito:</label>
        <select id="distritos" class="form-select">
          <option value="">-- Selecione um distrito --</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="locations" class="form-label">Localidade:</label>
        <select id="locations" class="form-select">
          <option value="">-- Selecione uma localidade --</option>
        </select>
      </div>
    </div>

    <button id="btn-previsao" class="btn btn-primary mb-4">Ver Previsão</button>

    <div class="row mb-3">
  <div class="col-md-6">
    <label for="filtro-data" class="form-label">Filtrar por data:</label>
    <input type="date" id="filtro-data" class="form-control">
  </div>
</div>
    <h2>Previsão do Tempo:</h2>
    <div id="resultado-previsao" class="row"></div>
  </div>

  <script>
    
  let todasAsLocalidades = [];
  let dadosOriginais = []; // Para armazenar os dados recebidos

 

  // Funções para carregar distritos e localidades e preencher os selects
  async function carregarDistritos() {
    const res = await fetch('/get_distritos');
    const distritos = await res.json();

    const select = document.getElementById('distritos');
    distritos.forEach(d => {
      const option = document.createElement('option');
      option.value = d.idDistrito;
      option.textContent = d.nome;
      select.appendChild(option);
    });
  }

  async function carregarLocalidades() {
    const res = await fetch('/get_locations');
    todasAsLocalidades = await res.json();
  }

  // Cria o select de localidades baseado no distrito selecionado
  function filtrarLocalidadesPorDistrito(idDistrito) {
    const select = document.getElementById('locations');
    select.innerHTML = '<option value="">-- Selecione uma localidade --</option>';

    const filtradas = todasAsLocalidades.filter(loc => loc.idDistrito == idDistrito);
    filtradas.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc.globalIdLocal;
      option.textContent = loc.local;
      select.appendChild(option);
    });
  }
 
  // Função para renderizar os cards de previsão no HTML
  function renderizarPrevisoes(dados) {
    const resultado = document.getElementById('resultado-previsao');
    resultado.innerHTML = "";
    
    if (dados.length === 0) {
      resultado.innerHTML = "<p>Nenhuma previsão encontrada para a data selecionada.</p>";
      return;
    }
    
    dados.forEach(dia => {
      
      const card = document.createElement('div');
      card.className = "col-md-4 mb-4";
      
      card.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">${new Date(dia.data).toLocaleDateString('pt-BR')}</h5>
            <p class="card-text">
              <img src="https://www.ipma.pt${dia.imagem}" alt="${dia.tempo}" width="48" height="48">
              <strong>${dia.tempo}</strong><br>
              <strong>Intervalo:</strong> ${dia.intervaloHora || ''} <br>
              <strong>Máxima:</strong> ${dia.temp_max}°C<br>
              <strong>Mínima:</strong> ${dia.temp_min}°C<br>
              <strong>Precipitação:</strong> ${dia.probabilidadePrecipita || 0}%<br>
              <strong>Vento:</strong> ${dia.direcao_vento} (força ${dia.vento})<br>
              <strong>Índice UV:</strong> ${dia.iuv?.replace('IUV:', '').trim() || 'N/A'}<br>            </p>
          </div>
        </div>
      `;

      resultado.appendChild(card);
    });
  }

 
  // Evento para buscar a previsão ao clicar no botão
  document.getElementById('btn-previsao').addEventListener('click', async () => {
    
    const distrito = document.getElementById('distritos').selectedOptions[0];
    const location = document.getElementById('locations').selectedOptions[0];
  

    const resultado = document.getElementById('resultado-previsao');
    
   
    if (!distrito.value || !location.value) {
        resultado.innerHTML = "<p class='text-danger'>Por favor, selecione um distrito e uma localidade.</p>";
        return;
        }

    resultado.innerHTML = "<p>Carregando previsão...</p>";

    try {

      // Obtém a data selecionada no filtro se houver traz uma data específica se não, traz a previsão atual para todos os dias
      const dataSelecionada = document.getElementById('filtro-data').value;
      
      const res = await fetch(`/api_playwright?distrito=${distrito.text}&location=${location.text}&data=${dataSelecionada || ''}`);
      const dados = await res.json();

      
      renderizarPrevisoes(dados.previsao);

    } catch (err) {
      console.error("Erro ao buscar previsão:", err);
      resultado.innerHTML = "<p class='text-danger'>Erro ao obter previsão.</p>";
    }
  });

  // Evento para filtrar previsões por data ao alterar o campo de data
  document.getElementById('filtro-data').addEventListener('change', async (e) => {
  const dataSelecionada = e.target.value;
  const distrito = document.getElementById('distritos').selectedOptions[0].text;
  const location = document.getElementById('locations').selectedOptions[0].text;
  
  try {
     
      const response = await fetch(`/api_playwright?distrito=${distrito}&location=${location}&data=${dataSelecionada || ''}`);

      const dados = await response.json();
      if (!dados || !dados.previsao || dados.previsao.length === 0) {
        document.getElementById('resultado-previsao').innerHTML = "<p>Nenhuma previsão encontrada para a data selecionada.</p>";
        return;
      }
      // Chama função que lida com os dados filtrados
      renderizarPrevisoes(dados.previsao);
  
  } catch (error) {
    console.error('Erro ao buscar dados com data:', error);
  }
});

  // Evento para carregar distritos e localidades ao carregar a página 
  document.addEventListener('DOMContentLoaded', async () => {
    await carregarDistritos();
    await carregarLocalidades();

    // Preenche o select de localidades com base no distrito selecionado
    document.getElementById('distritos').addEventListener('change', (e) => {
      const idDistrito = e.target.value;
      if (idDistrito) {
        filtrarLocalidadesPorDistrito(idDistrito);
      } else {
        document.getElementById('locations').innerHTML = '<option value="">-- Selecione uma localidade --</option>';
      }
    });
  });


  </script>
</body>
</html>
